<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每日温度 - 算法可视化</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        .cell-transition { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .bar-transition { transition: height 0.4s ease-out, background-color 0.3s; }
        .fade-enter { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* 栈元素动画 */
        .stack-item-enter { animation: slideInLeft 0.3s forwards; }
        .stack-item-exit { animation: slideOutRight 0.3s forwards; }
        @keyframes slideInLeft { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideOutRight { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(20px); } }
    </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- 图标组件 ---
    const Icons = {
        Play: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>,
        Pause: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>,
        Step: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>,
        Reset: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12" /><path d="M3 3v9h9" /></svg>,
        Settings: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>,
        Shuffle: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>
    };

    // --- 辅助函数 ---
    const parseInput = (str) => {
        return str.split(/[,，\s]+/)
            .map(v => parseInt(v.trim()))
            .filter(v => !isNaN(v));
    };

    const App = () => {
        // --- 状态定义 ---
        const [inputStr, setInputStr] = useState("73, 74, 75, 71, 69, 72, 76, 73");

        // 核心数据
        const [temps, setTemps] = useState([73, 74, 75, 71, 69, 72, 76, 73]);
        const [result, setResult] = useState([]); // 结果数组
        const [stack, setStack] = useState([]); // 单调栈 (存储索引)

        // 运行指针
        const [currentIdx, setCurrentIdx] = useState(0);

        // 运行控制
        const [isPlaying, setIsPlaying] = useState(false);
        const [isFinished, setIsFinished] = useState(false);
        const [message, setMessage] = useState("准备就绪");
        const [phase, setPhase] = useState("compare"); // 'compare' -> 'pop' or 'push' -> 'next'

        // 高亮状态
        const [highlightStackIdx, setHighlightStackIdx] = useState(-1); // 栈顶正在比较的索引
        const [lastPoppedIdx, setLastPoppedIdx] = useState(-1); // 刚弹出的索引 (用于显示连线动画)

        const timerRef = useRef(null);

        // --- 初始化 ---
        const reset = (arr = temps) => {
            setIsPlaying(false);
            setIsFinished(false);
            setTemps(arr);
            setResult(new Array(arr.length).fill(0));
            setStack([]);
            setCurrentIdx(0);
            setPhase("compare");
            setHighlightStackIdx(-1);
            setLastPoppedIdx(-1);
            setMessage("状态已重置。准备开始遍历。");
            if (timerRef.current) clearInterval(timerRef.current);
        };

        const loadInput = () => {
            const arr = parseInput(inputStr);
            if (arr.length === 0) return;
            reset(arr);
            setMessage(`已加载数据，共 ${arr.length} 天`);
        };

        const randomInput = () => {
            const len = 8 + Math.floor(Math.random() * 5);
            const arr = Array.from({length: len}, () => Math.floor(Math.random() * 20) + 60); // 60-80
            const str = arr.join(", ");
            setInputStr(str);
            reset(arr);
            setMessage("随机温度数据生成完毕。");
        };

        useEffect(() => {
            reset();
        }, []);

        // --- 核心算法逻辑 ---
        // 逻辑流: Compare (check stack top) -> Pop (if warmer) -> Push (if not warmer or empty)
        const stepForward = () => {
            if (currentIdx >= temps.length && stack.length >= 0) {
                // 遍历结束，剩下的栈元素保持 0
                setIsFinished(true);
                setIsPlaying(false);
                setMessage("遍历结束。栈中剩余日期的等待天数为 0。");
                return;
            }

            const currentVal = temps[currentIdx];
            const nextResult = [...result];
            const nextStack = [...stack];

            // 1. 比较阶段
            if (phase === "compare") {
                if (nextStack.length > 0) {
                    const topIdx = nextStack[nextStack.length - 1];
                    setHighlightStackIdx(topIdx);

                    if (currentVal > temps[topIdx]) {
                        setMessage(`当前 ${currentVal}°C > 栈顶 ${temps[topIdx]}°C (Day ${topIdx})。变暖了！准备出栈。`);
                        setPhase("pop");
                    } else {
                        setMessage(`当前 ${currentVal}°C <= 栈顶 ${temps[topIdx]}°C。未变暖。准备入栈。`);
                        setPhase("push");
                    }
                } else {
                    setMessage("栈为空。准备入栈。");
                    setPhase("push");
                }
                return;
            }

            // 2. 出栈阶段 (更新结果)
            if (phase === "pop") {
                const topIdx = nextStack.pop();
                const days = currentIdx - topIdx;
                nextResult[topIdx] = days;

                setStack(nextStack);
                setResult(nextResult);
                setLastPoppedIdx(topIdx);
                setMessage(`Day ${topIdx} 出栈。等待了 ${days} 天 (Day ${currentIdx} - Day ${topIdx})。继续比较新栈顶。`);

                // 回到 compare 继续检查新的栈顶
                setPhase("compare");
                return;
            }

            // 3. 入栈阶段 (移动到下一天)
            if (phase === "push") {
                nextStack.push(currentIdx);
                setStack(nextStack);
                setMessage(`Day ${currentIdx} (${currentVal}°C) 入栈。移动到下一天。`);

                setLastPoppedIdx(-1);
                setHighlightStackIdx(-1);
                setCurrentIdx(prev => prev + 1);
                setPhase("compare");
                return;
            }
        };

        // --- 自动播放 ---
        useEffect(() => {
            let timer;
            if (isPlaying && !isFinished) {
                timer = setInterval(() => {
                    stepForward();
                }, 1000);
            }
            return () => clearInterval(timer);
        }, [isPlaying, isFinished, phase, currentIdx, stack, temps, result]);

        // --- 渲染 ---

        // 计算条形高度
        const getBarHeight = (temp) => {
            const min = Math.min(...temps) - 5;
            const max = Math.max(...temps);
            const range = Math.max(10, max - min); // Avoid div by zero
            return 40 + ((temp - min) / range) * 100; // 40px base + variable
        };

        // 颜色映射 (Blue -> Red)
        const getTempColor = (temp) => {
            if (temp < 60) return "bg-blue-400";
            if (temp < 70) return "bg-sky-400";
            if (temp < 80) return "bg-orange-400";
            return "bg-red-500";
        };

        return (
            <div className="max-w-4xl mx-auto p-4 sm:p-6">
                {/* 1. 顶部配置 */}
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-6">
                    <div className="flex items-center gap-2 mb-3 text-slate-700 font-bold">
                        <Icons.Settings />
                        <span>数据配置</span>
                    </div>
                    <div className="flex flex-col sm:flex-row gap-3">
                        <div className="flex-1 space-y-1">
                            <label className="text-xs text-slate-400 font-bold uppercase">温度序列</label>
                            <input
                                type="text"
                                value={inputStr}
                                onChange={(e) => setInputStr(e.target.value)}
                                className="w-full border border-slate-300 rounded-lg px-3 py-2 font-mono text-sm focus:outline-none focus:ring-2 focus:ring-orange-500"
                                placeholder="73, 74, 75..."
                            />
                        </div>
                        <div className="flex gap-2 items-end">
                            <button onClick={loadInput} className="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition font-medium text-sm h-[38px]">
                                加载
                            </button>
                            <button onClick={randomInput} className="px-3 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 transition h-[38px]" title="随机生成">
                                <Icons.Shuffle />
                            </button>
                        </div>
                    </div>
                </div>

                {/* 2. 主体区 */}
                <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                    {/* Header */}
                    <div className="border-b border-slate-100 bg-slate-50 p-4 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div>
                            <h1 className="text-xl font-bold text-slate-800">每日温度 (Daily Temperatures)</h1>
                            <p className="text-xs text-slate-500 mt-1">单调栈 (Monotonic Stack) · O(N)</p>
                        </div>
                        <div className="flex gap-4 text-xs font-mono">
                            <div className="flex items-center gap-1">
                                <span className="w-2 h-2 rounded-full bg-orange-500"></span> Current
                            </div>
                            <div className="flex items-center gap-1">
                                <span className="w-2 h-2 rounded-full bg-indigo-500"></span> In Stack
                            </div>
                        </div>
                    </div>

                    {/* Canvas */}
                    <div className="p-6 sm:p-10 bg-slate-50 min-h-[350px] flex flex-col items-center justify-between">

                        {/* Stack Visualization (Top) */}
                        <div className="w-full max-w-2xl bg-white border border-slate-200 rounded-lg p-3 min-h-[80px] flex items-center justify-start gap-2 overflow-x-auto relative mb-6 shadow-inner">
                            <div className="absolute left-0 top-0 bottom-0 bg-slate-100 px-2 flex items-center border-r border-slate-200 text-xs font-bold text-slate-400 z-10">STACK</div>
                            <div className="pl-12 flex gap-2 w-full">
                                {stack.length === 0 ? <span className="text-slate-300 text-sm italic">Empty</span> :
                                    stack.map((idx, i) => (
                                        <div key={idx} className={`flex flex-col items-center p-2 rounded border-2 min-w-[50px] stack-item-enter transition-colors duration-300
                                            ${idx === highlightStackIdx ? 'bg-indigo-100 border-indigo-500' : 'bg-slate-50 border-slate-300'}
                                        `}>
                                            <span className="text-sm font-bold text-slate-700">{temps[idx]}°</span>
                                            <span className="text-[10px] text-slate-400">Day {idx}</span>
                                        </div>
                                    ))
                                }
                            </div>
                        </div>

                        {/* Bar Chart Visualization (Bottom) */}
                        <div className="flex items-end justify-center gap-2 h-[200px] w-full overflow-x-auto pb-8 relative">
                            {temps.map((temp, idx) => {
                                const isCurrent = idx === currentIdx;
                                const inStack = stack.includes(idx);
                                const isPopped = idx === lastPoppedIdx;
                                const isTop = stack.length > 0 && stack[stack.length-1] === idx;
                                const height = getBarHeight(temp);

                                let barClass = getTempColor(temp); // Default
                                if (isCurrent) barClass = "bg-orange-500 ring-4 ring-orange-200 z-10";
                                else if (isTop && phase === 'compare') barClass = "bg-indigo-500 ring-4 ring-indigo-200 z-10"; // Highlight top during compare
                                else if (inStack) barClass = "bg-indigo-400 opacity-80";
                                else if (result[idx] > 0) barClass = "bg-green-500 opacity-60"; // Done
                                else if (idx < currentIdx) barClass = "bg-slate-300 opacity-40"; // Processed but 0

                                return (
                                    <div key={idx} className="flex flex-col items-center group relative w-10 sm:w-12 flex-shrink-0">
                                        {/* Result Bubble */}
                                        <div className={`absolute -top-8 text-xs font-bold px-2 py-0.5 rounded-full transition-all duration-500
                                            ${result[idx] > 0 ? 'bg-green-100 text-green-700 scale-100 opacity-100' : 'scale-0 opacity-0'}
                                        `}>
                                            {result[idx]}d
                                        </div>

                                        {/* Current Indicator */}
                                        {isCurrent && !isFinished && (
                                            <div className="absolute -top-12 text-orange-600 animate-bounce font-bold text-lg">↓</div>
                                        )}

                                        {/* Bar */}
                                        <div
                                            className={`w-full rounded-t-md shadow-sm flex items-end justify-center pb-2 text-white font-bold text-sm bar-transition ${barClass}`}
                                            style={{ height: `${height}px` }}
                                        >
                                            {temp}
                                        </div>

                                        {/* Index Label */}
                                        <span className={`mt-2 text-xs font-mono ${isCurrent ? 'text-orange-600 font-bold' : 'text-slate-400'}`}>
                                            {idx}
                                        </span>

                                        {/* Connection Line (Pop Animation) */}
                                        {phase === 'pop' && isPopped && isCurrent && (
                                            // Ideally use SVG overlay for line, simplified here with logic
                                            // Using parent message to explain connection
                                            null
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* Controls */}
                    <div className="border-t border-slate-100 p-4 bg-white">
                        <div className="flex flex-col sm:flex-row items-center justify-between gap-4">
                            <div className={`flex-1 px-4 py-3 rounded-lg text-sm border-l-4 w-full sm:w-auto transition-colors ${phase === 'pop' ? 'bg-green-50 text-green-900 border-green-500' : phase === 'push' ? 'bg-slate-100 text-slate-600 border-slate-400' : 'bg-orange-50 text-orange-900 border-orange-500'}`}>
                                {message}
                            </div>

                            <div className="flex items-center gap-2">
                                <button onClick={() => setIsPlaying(!isPlaying)} disabled={isFinished} className={`flex items-center gap-2 px-4 py-2 rounded-lg text-white font-medium transition ${isPlaying ? 'bg-slate-500 hover:bg-slate-600' : 'bg-orange-500 hover:bg-orange-600'} disabled:opacity-50`}>
                                    {isPlaying ? <Icons.Pause /> : <Icons.Play />}
                                    <span className="hidden sm:inline">{isPlaying ? "暂停" : "运行"}</span>
                                </button>
                                <button onClick={stepForward} disabled={isPlaying || isFinished} className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 font-medium transition disabled:opacity-50">
                                    <Icons.Step />
                                    <span className="hidden sm:inline">单步</span>
                                </button>
                                <button onClick={() => reset()} className="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition" title="重置">
                                    <Icons.Reset />
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>