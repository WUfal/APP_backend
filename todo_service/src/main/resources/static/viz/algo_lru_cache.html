<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>算法可视化：LRU 缓存淘汰策略</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Custom Styles -->
    <style>
        body {
            background-color: #fffbeb; /* amber-50 */
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        .smooth-transition {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* 列表项动画 */
        .list-item-enter {
            opacity: 0;
            transform: translateY(-20px) scale(0.9);
        }
        .list-item-enter-active {
            opacity: 1;
            transform: translateY(0) scale(1);
            transition: all 400ms ease-out;
        }
        .list-item-exit {
            opacity: 1;
            transform: scale(1);
        }
        .list-item-exit-active {
            opacity: 0;
            transform: scale(0.9) translateY(20px);
            transition: all 400ms ease-in;
        }

        /* 滚动条美化 */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #fef3c7; }
        ::-webkit-scrollbar-thumb { background: #d97706; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #b45309; }
    </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- 图标组件 ---
    const Icons = {
        Play: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>,
        Pause: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>,
        Step: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg>,
        Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>,
        Code: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>,
        Random: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>
    };

    // --- 辅助函数：解析指令 ---
    // 支持格式: "put 1 A, get 1, put 2 B"
    const parseCommands = (str) => {
        if (!str) return [];
        return str.split(/[,，\n]+/).map(cmd => {
            cmd = cmd.trim().toLowerCase();
            const parts = cmd.split(/\s+/);
            if (parts[0] === 'put' && parts.length >= 3) {
                return { type: 'put', key: parts[1], val: parts[2] };
            }
            if (parts[0] === 'get' && parts.length >= 2) {
                return { type: 'get', key: parts[1] };
            }
            return null;
        }).filter(Boolean);
    };

    // --- 主应用组件 ---
    function App() {
        // --- Configuration State ---
        const [capacity, setCapacity] = useState(3);
        const [cmdInput, setCmdInput] = useState("put 1 A, put 2 B, put 3 C, get 1, put 4 D, get 2");
        const [mode, setMode] = useState('LRU'); // 'LRU' | 'FIFO'

        // --- Runtime State ---
        const [cache, setCache] = useState([]); // Array of {key, val, status}
        // status: 'normal', 'new', 'hit', 'evicting'
        const [commands, setCommands] = useState([]);
        const [currentCmdIdx, setCurrentCmdIdx] = useState(0);

        const [isPlaying, setIsPlaying] = useState(false);
        const [isCompleted, setIsCompleted] = useState(false);
        const [message, setMessage] = useState("准备就绪。请配置参数或直接开始。");
        const [statusColor, setStatusColor] = useState("text-slate-600");

        const timerRef = useRef(null);

        // --- Initialization & Data Handling ---

        const initAlgorithm = (newCmds = null, newCap = null) => {
            const cmds = newCmds || parseCommands(cmdInput);
            const cap = newCap !== null ? newCap : capacity;

            setCommands(cmds);
            setCache([]);
            setCurrentCmdIdx(0);
            setIsCompleted(false);
            setIsPlaying(false);
            setMessage("状态已重置，等待执行。");
            setStatusColor("text-slate-600");
            if (timerRef.current) clearInterval(timerRef.current);
        };

        const handleApply = () => {
            initAlgorithm();
        };

        const handleRandom = () => {
            const keys = [1, 2, 3, 4, 5];
            const vals = ['A', 'B', 'C', 'D', 'E'];
            let str = "";
            for(let i=0; i<8; i++) {
                const isPut = Math.random() > 0.4; // 60% put
                const k = keys[Math.floor(Math.random()*keys.length)];
                if(isPut) {
                    const v = vals[Math.floor(Math.random()*vals.length)];
                    str += `put ${k} ${v}`;
                } else {
                    str += `get ${k}`;
                }
                if(i < 7) str += ", ";
            }
            setCmdInput(str);
            initAlgorithm(parseCommands(str));
            setMessage("随机指令已生成。");
        };

        // 模式切换时重置
        useEffect(() => {
            initAlgorithm();
        }, [mode]);

        // --- Algorithm Logic (Single Step) ---

        const step = () => {
            if (currentCmdIdx >= commands.length) {
                setIsCompleted(true);
                setIsPlaying(false);
                setMessage("所有指令执行完毕。");
                setStatusColor("text-slate-600");
                return;
            }

            const cmd = commands[currentCmdIdx];
            let nextCache = cache.map(item => ({...item, status: 'normal'})); // Reset status
            let msg = "";
            let color = "text-slate-600";

            if (cmd.type === 'put') {
                // Check if exists
                const existingIdx = nextCache.findIndex(item => item.key === cmd.key);

                if (existingIdx !== -1) {
                    // Key Exists: Update value
                    if (mode === 'LRU') {
                        // LRU: Move to front (Update & Promote)
                        const item = nextCache.splice(existingIdx, 1)[0];
                        item.val = cmd.val;
                        item.status = 'hit'; // Visual highlight
                        nextCache.unshift(item);
                        msg = `Put(${cmd.key}, ${cmd.val}): 键已存在。更新值并移至头部 (最近使用)。`;
                        color = "text-green-600";
                    } else {
                        // FIFO: Just update value, position unchanged
                        nextCache[existingIdx].val = cmd.val;
                        nextCache[existingIdx].status = 'hit';
                        msg = `Put(${cmd.key}, ${cmd.val}): 键已存在。更新值 (FIFO模式位置不变)。`;
                        color = "text-green-600";
                    }
                } else {
                    // Key New
                    const newItem = { key: cmd.key, val: cmd.val, status: 'new', id: Date.now() + Math.random() };

                    if (nextCache.length < capacity) {
                        // Not full: Just add to front (LRU) or back (FIFO)
                        // Usually cache logic adds to head/tail.
                        // Visualizing LRU: Head = MRU, Tail = LRU. So insert at Head.
                        // Visualizing FIFO: Head = Oldest, Tail = Newest. Insert at Tail.

                        if (mode === 'LRU') {
                            nextCache.unshift(newItem); // Insert Head
                        } else {
                            nextCache.push(newItem); // Insert Tail
                        }
                        msg = `Put(${cmd.key}, ${cmd.val}): 缓存未满，插入新节点。`;
                        color = "text-blue-600";
                    } else {
                        // Full: Evict
                        if (mode === 'LRU') {
                            // Evict Tail (LRU)
                            const evicted = nextCache.pop();
                            nextCache.unshift(newItem);
                            msg = `Put(${cmd.key}, ${cmd.val}): 缓存已满！淘汰尾部 (最久未使用) [${evicted.key}:${evicted.val}]，插入头部。`;
                            color = "text-amber-600"; // Warn color
                        } else {
                            // Evict Head (Oldest in FIFO)
                            const evicted = nextCache.shift();
                            nextCache.push(newItem);
                            msg = `Put(${cmd.key}, ${cmd.val}): 缓存已满！淘汰头部 (最早进入) [${evicted.key}:${evicted.val}]，插入尾部。`;
                            color = "text-amber-600";
                        }
                    }
                }

            } else if (cmd.type === 'get') {
                const existingIdx = nextCache.findIndex(item => item.key === cmd.key);

                if (existingIdx !== -1) {
                    // Hit
                    const item = nextCache[existingIdx];
                    if (mode === 'LRU') {
                        // LRU: Move to front
                        nextCache.splice(existingIdx, 1);
                        item.status = 'hit';
                        nextCache.unshift(item);
                        msg = `Get(${cmd.key}): 命中！返回值 ${item.val} 并移至头部 (提升热度)。`;
                        color = "text-green-600";
                    } else {
                        // FIFO: Do not move
                        item.status = 'hit';
                        msg = `Get(${cmd.key}): 命中！返回值 ${item.val} (FIFO模式不改变位置)。`;
                        color = "text-green-600";
                    }
                } else {
                    // Miss
                    msg = `Get(${cmd.key}): 未找到该键 (Miss)。`;
                    color = "text-red-500";
                }
            }

            setCache(nextCache);
            setMessage(msg);
            setStatusColor(color);
            setCurrentCmdIdx(prev => prev + 1);
        };

        // --- Auto Play ---
        useEffect(() => {
            if (isPlaying) {
                timerRef.current = setInterval(() => {
                    step();
                }, 1200); // 1.2s per step to allow animation
            }
            return () => clearInterval(timerRef.current);
        }, [isPlaying, commands, cache, currentCmdIdx, mode]);

        // --- Render Helpers ---

        // Calculate progress for command list scroll
        const cmdListRef = useRef(null);
        useEffect(() => {
            if(cmdListRef.current && currentCmdIdx > 0) {
                // Simple scroll follow
                const el = cmdListRef.current.children[currentCmdIdx];
                if(el) el.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "center" });
            }
        }, [currentCmdIdx]);

        return (
            <div className="min-h-screen flex flex-col items-center py-8 px-4 sm:px-6">

                {/* 1. Header */}
                <header className="mb-8 text-center space-y-2">
                    <h1 className="text-3xl font-extrabold text-slate-800 tracking-tight">
                        算法可视化：<span className="text-amber-600">LRU 缓存淘汰</span>
                    </h1>
                    <p className="text-slate-500 text-sm">
                        对比 <span className="font-semibold text-slate-700">LRU (最近最少使用)</span> 与 <span className="font-semibold text-slate-700">FIFO (先进先出)</span>
                    </p>
                </header>

                {/* 2. Configuration Card */}
                <div className="w-full max-w-4xl bg-white rounded-xl shadow-lg border border-amber-100 p-6 mb-8">
                    {/* Mode Tabs */}
                    <div className="flex justify-center mb-6">
                        <div className="bg-amber-50 p-1 rounded-lg flex space-x-1">
                            <button
                                onClick={() => setMode('FIFO')}
                                className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${mode === 'FIFO' ? 'bg-white text-amber-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                            >
                                解法一：FIFO 队列 (简单公平)
                            </button>
                            <button
                                onClick={() => setMode('LRU')}
                                className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${mode === 'LRU' ? 'bg-white text-amber-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                            >
                                解法二：LRU 哈希链表 (热度优先)
                            </button>
                        </div>
                    </div>

                    {/* Controls */}
                    <div className="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                        <div className="md:col-span-2 space-y-1">
                            <label className="text-xs font-semibold text-slate-500 uppercase">容量 (Capacity)</label>
                            <input
                                type="number"
                                min="1" max="10"
                                value={capacity}
                                onChange={(e) => setCapacity(parseInt(e.target.value))}
                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none text-slate-700 text-sm font-mono"
                            />
                        </div>
                        <div className="md:col-span-7 space-y-1">
                            <label className="text-xs font-semibold text-slate-500 uppercase">指令序列 (Put k v / Get k)</label>
                            <input
                                type="text"
                                value={cmdInput}
                                onChange={(e) => setCmdInput(e.target.value)}
                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none text-slate-700 text-sm font-mono"
                                placeholder="put 1 A, get 1..."
                            />
                        </div>
                        <div className="md:col-span-3 flex space-x-2">
                            <button
                                onClick={handleApply}
                                className="flex-1 flex items-center justify-center space-x-1 bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded-lg transition-colors text-sm font-medium"
                            >
                                <Icons.Refresh /> <span>重置</span>
                            </button>
                            <button
                                onClick={handleRandom}
                                className="flex-1 flex items-center justify-center space-x-1 bg-white border border-slate-300 hover:bg-amber-50 text-slate-700 px-4 py-2 rounded-lg transition-colors text-sm font-medium"
                            >
                                <Icons.Random /> <span>随机</span>
                            </button>
                        </div>
                    </div>
                </div>

                {/* 3. Visualization Area */}
                <div className="w-full max-w-4xl mb-8 space-y-4">

                    {/* 3.1 Command Queue */}
                    <div className="bg-slate-50 rounded-lg p-2 border border-slate-200 overflow-hidden">
                        <div className="flex items-center space-x-2 overflow-x-auto no-scrollbar pb-1" ref={cmdListRef}>
                            {commands.map((cmd, idx) => (
                                <div key={idx}
                                     className={`flex-shrink-0 px-3 py-1 rounded-md text-xs font-mono border transition-all duration-300
                                            ${idx === currentCmdIdx
                                         ? 'bg-amber-100 border-amber-500 text-amber-800 scale-105 shadow-sm font-bold'
                                         : idx < currentCmdIdx
                                             ? 'bg-slate-100 border-slate-200 text-slate-400 opacity-60'
                                             : 'bg-white border-slate-200 text-slate-600'}`}
                                >
                                    {cmd.type.toUpperCase()} {cmd.key} {cmd.val ? cmd.val : ''}
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* 3.2 Cache Container */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 min-h-[160px] relative">
                        {/* Label Indicators */}
                        <div className="absolute top-2 left-4 text-xs font-bold text-slate-400 uppercase tracking-wider">
                            {mode === 'LRU' ? 'Most Recently Used (Head)' : 'Oldest (Head)'}
                        </div>
                        <div className="absolute top-2 right-4 text-xs font-bold text-slate-400 uppercase tracking-wider">
                            {mode === 'LRU' ? 'Least Recently Used (Tail)' : 'Newest (Tail)'}
                        </div>

                        {/* Cache Items */}
                        <div className="flex items-center justify-start space-x-4 mt-6 overflow-x-auto p-2 pb-4">
                            {cache.length === 0 && (
                                <div className="w-full text-center text-slate-400 italic py-8">
                                    缓存为空 (Capacity: {capacity})
                                </div>
                            )}
                            {cache.map((item, idx) => (
                                <div key={item.id} className={`
                                        flex-shrink-0 w-20 h-24 flex flex-col rounded-lg border-2 shadow-sm transition-all duration-500 relative
                                        ${item.status === 'new' ? 'border-blue-400 bg-blue-50 animate-bounce' :
                                    item.status === 'hit' ? 'border-green-500 bg-green-50 scale-110 z-10' :
                                        'border-amber-200 bg-white'}
                                    `}>
                                    {/* Key */}
                                    <div className="flex-1 flex items-center justify-center bg-slate-50 rounded-t-md border-b border-slate-100 font-mono font-bold text-slate-700">
                                        {item.key}
                                    </div>
                                    {/* Val */}
                                    <div className="flex-1 flex items-center justify-center font-serif text-slate-600">
                                        {item.val}
                                    </div>
                                    {/* Index Badge */}
                                    <div className="absolute -bottom-3 left-1/2 transform -translate-x-1/2 bg-slate-200 text-slate-500 text-[10px] px-1.5 rounded-full">
                                        {idx}
                                    </div>
                                </div>
                            ))}
                            {/* Empty Slots Indicators */}
                            {Array.from({ length: Math.max(0, capacity - cache.length) }).map((_, i) => (
                                <div key={`empty-${i}`} className="w-20 h-24 rounded-lg border-2 border-dashed border-slate-200 flex items-center justify-center text-slate-300">
                                    Empty
                                </div>
                            ))}
                        </div>
                    </div>
                </div>

                {/* 4. Control Bar & Log */}
                <div className="w-full max-w-2xl bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden">

                    <div className="flex items-center justify-between p-4 bg-slate-50 border-b border-slate-100">
                        <div className="flex space-x-2">
                            {!isPlaying ? (
                                <button
                                    onClick={() => setIsPlaying(true)}
                                    disabled={isCompleted}
                                    className="flex items-center space-x-1 bg-amber-600 hover:bg-amber-700 disabled:bg-amber-300 text-white px-4 py-2 rounded-lg transition-colors text-sm font-medium"
                                >
                                    <Icons.Play /> <span>运行</span>
                                </button>
                            ) : (
                                <button
                                    onClick={() => setIsPlaying(false)}
                                    className="flex items-center space-x-1 bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition-colors text-sm font-medium"
                                >
                                    <Icons.Pause /> <span>暂停</span>
                                </button>
                            )}

                            <button
                                onClick={step}
                                disabled={isPlaying || isCompleted}
                                className="flex items-center space-x-1 bg-white border border-slate-300 hover:bg-slate-50 disabled:opacity-50 text-slate-700 px-4 py-2 rounded-lg transition-colors text-sm font-medium"
                            >
                                <Icons.Step /> <span>单步</span>
                            </button>
                        </div>

                        <div className="text-xs text-slate-400 font-mono">
                            {currentCmdIdx} / {commands.length} Ops
                        </div>
                    </div>

                    <div className="p-6 bg-white min-h-[100px] flex items-center justify-center text-center">
                        <p className={`text-lg font-medium transition-colors duration-300 ${statusColor}`}>
                            {message}
                        </p>
                    </div>

                    {isPlaying && (
                        <div className="h-1 w-full bg-slate-100 overflow-hidden">
                            <div className="h-full bg-amber-500 animate-progress origin-left"></div>
                        </div>
                    )}
                </div>

                <div className="mt-8 text-slate-400 text-xs text-center">
                    <p>LRU Cache Visualization • React + Tailwind</p>
                </div>

            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>

<style>
    @keyframes progress {
        0% { width: 0%; }
        100% { width: 100%; }
    }
    .animate-progress {
        animation: progress 1.2s linear infinite;
    }
</style>
</body>
</html>