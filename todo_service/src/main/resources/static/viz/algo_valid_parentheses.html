<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>有效的括号 - 栈演示</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0fdfa; /* Teal-50 */
            color: #134e4a; /* Teal-900 */
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }

        /* 隐藏滚动条 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* 动画 */
        .transition-all-300 { transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .transition-transform-500 { transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }

        /* 栈元素动画 */
        .stack-enter {
            animation: stackDrop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        .stack-leave {
            animation: stackPop 0.3s ease-in forwards;
        }

        @keyframes stackDrop {
            from { opacity: 0; transform: translateY(-20px) scale(0.8); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes stackPop {
            to { opacity: 0; transform: translateY(-20px) scale(0.8); }
        }

        /* 状态高亮 */
        .char-active {
            background-color: #0d9488 !important; /* Teal-600 */
            color: white !important;
            transform: scale(1.15);
            box-shadow: 0 4px 6px -1px rgba(13, 148, 136, 0.4);
            z-index: 10;
        }

        .char-processed {
            opacity: 0.4;
            background-color: #ccfbf1 !important; /* Teal-100 */
        }

        .char-error {
            background-color: #ef4444 !important; /* Red-500 */
            color: white !important;
        }

        .char-success {
            background-color: #22c55e !important; /* Green-500 */
            color: white !important;
        }

        /* 安全区域适配 */
        .safe-pt { padding-top: max(1rem, env(safe-area-inset-top)); }
        .safe-pb { padding-bottom: max(1rem, env(safe-area-inset-bottom)); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-[#f0fdfa]">

<!-- 1. 顶部栏 -->
<header class="safe-pt pb-2 px-4 bg-[#f0fdfa] shrink-0 z-50 relative shadow-[0_1px_2px_rgba(0,0,0,0.05)]">
    <div class="flex justify-between items-center mb-2">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-[#ccfbf1] text-[#0f766e] flex items-center justify-center font-bold">
                ()
            </div>
            <div>
                <h1 class="text-xl font-bold text-[#115e59]">有效的括号</h1>
                <p class="text-[10px] text-[#0f766e] font-medium">Stack LIFO · O(n)</p>
            </div>
        </div>
        <button onclick="openEditModal()" class="p-2 rounded-full hover:bg-teal-100 text-[#0f766e] transition-colors">
            <i data-lucide="settings-2" class="w-6 h-6"></i>
        </button>
    </div>
</header>

<!-- 2. 主可视区域 -->
<main class="flex-1 flex flex-col items-center relative overflow-y-auto no-scrollbar pb-20">

    <!-- 核心状态展示 -->
    <div class="flex gap-3 w-full px-4 justify-center mt-6 mb-4 shrink-0">
        <!-- 当前字符 -->
        <div class="bg-white p-3 rounded-2xl shadow-sm border border-teal-100 min-w-[90px] flex flex-col items-center">
            <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Current</span>
            <span id="curr-char" class="text-3xl font-bold text-[#0d9488] font-mono mt-1">--</span>
        </div>

        <!-- 匹配状态 -->
        <div class="bg-white p-3 rounded-2xl shadow-sm border border-teal-100 flex-1 flex flex-col items-center justify-center transition-colors" id="status-box">
            <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Action</span>
            <div id="action-text" class="text-sm font-bold text-[#0f766e] mt-1 text-center leading-tight">
                Ready
            </div>
        </div>
    </div>

    <!-- 状态提示条 -->
    <div id="status-chip" class="mb-6 px-4 py-1.5 bg-[#ccfbf1] text-[#115e59] text-xs font-medium rounded-full shadow-sm transition-all duration-300 max-w-[90%] text-center truncate z-10 border border-teal-200">
        Stack is empty
    </div>

    <!-- 字符串输入流 (Horizontal) -->
    <div class="w-full px-4 mb-2 relative shrink-0">
        <div class="text-[10px] text-gray-400 font-bold ml-1 mb-1 uppercase tracking-wider">Input String</div>
        <div id="string-container" class="flex items-center gap-1.5 overflow-x-auto no-scrollbar py-2 px-1 min-h-[60px]">
            <!-- String chars injected here -->
        </div>

        <!-- 扫描指针 -->
        <div id="pointer-wrapper" class="absolute top-[3.5rem] left-4 transition-transform-500 opacity-0">
            <i data-lucide="arrow-up" class="w-5 h-5 text-[#0d9488]"></i>
        </div>
    </div>

    <!-- 栈可视化 (Vertical) -->
    <div class="flex-1 w-full px-4 flex justify-center items-end pb-2 min-h-[150px]">
        <div class="relative w-24 h-full max-h-[240px] flex flex-col-reverse items-center">
            <!-- Stack Container (U-shape) -->
            <div class="absolute inset-0 border-l-4 border-r-4 border-b-4 border-teal-200 rounded-b-xl pointer-events-none"></div>
            <div class="absolute -bottom-6 text-[10px] font-bold text-teal-300 uppercase tracking-widest">Stack</div>

            <!-- Stack Items -->
            <div id="stack-container" class="w-full flex flex-col-reverse items-center gap-1 mb-1 p-1 overflow-visible z-10">
                <!-- Stack items injected here -->
            </div>
        </div>
    </div>

</main>

<!-- 3. 代码面板 -->
<section class="bg-[#2b2930] text-[#e6e1e5] p-4 rounded-t-3xl shrink-0 h-40 overflow-y-auto no-scrollbar shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-20">
    <div class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-2 flex justify-between">
        <span>Algorithm Logic</span>
        <span class="text-teal-400">Python-like</span>
    </div>
    <div class="font-mono text-xs space-y-1.5" id="code-content">
        <div id="code-0">stack = []</div>
        <div id="code-1">for char in s:</div>
        <div id="code-2" class="pl-2">if char in ['(', '{', '[']:</div>
        <div id="code-3" class="pl-4">stack.append(char)</div>
        <div id="code-4" class="pl-2">else: # Closing bracket</div>
        <div id="code-5" class="pl-4">if not stack or stack.pop() != map[char]:</div>
        <div id="code-6" class="pl-6">return False</div>
        <div id="code-7">return not stack</div>
    </div>
</section>

<!-- 4. 底部控制栏 -->
<footer class="bg-white px-6 py-4 pb-8 border-t border-teal-50 flex items-center justify-between shrink-0 z-30 safe-pb">
    <button onclick="resetApp()" class="flex flex-col items-center gap-1 text-gray-400 active:scale-95 transition-transform w-12 hover:text-teal-600">
        <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
        <span class="text-[10px]">重置</span>
    </button>

    <div class="flex items-center gap-3 bg-[#f0fdfa] rounded-full p-1.5 pl-5 pr-1.5 shadow-inner border border-teal-100">
        <span id="step-count" class="text-xs font-mono text-teal-700 w-10 text-center">0</span>
        <button id="btn-play" onclick="togglePlay()" class="w-10 h-10 bg-[#0d9488] text-white rounded-full flex items-center justify-center shadow-lg shadow-teal-200 active:bg-[#0f766e] active:scale-95 transition-all">
            <i data-lucide="play" class="w-5 h-5 ml-0.5 fill-current"></i>
        </button>
        <button onclick="nextStep()" class="w-10 h-10 bg-white text-teal-700 rounded-full flex items-center justify-center border border-teal-100 shadow-sm active:bg-teal-50 active:scale-95 transition-all">
            <i data-lucide="step-forward" class="w-5 h-5"></i>
        </button>
    </div>

    <button onclick="changeSpeed()" class="flex flex-col items-center gap-1 text-gray-400 active:scale-95 transition-transform w-12 hover:text-teal-600">
        <div class="relative">
            <i data-lucide="zap" class="w-5 h-5"></i>
            <span id="speed-badge" class="absolute -top-1 -right-1 bg-[#ef4444] text-white text-[8px] px-1 rounded-full opacity-0">2x</span>
        </div>
        <span class="text-[10px]">速度</span>
    </button>
</footer>

<!-- 自定义数据 Modal -->
<div id="modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/30 backdrop-blur-sm opacity-0 transition-opacity" id="modal-bg" onclick="closeEditModal()"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl p-6 translate-y-full transition-transform duration-300" id="modal-panel">
        <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto mb-6"></div>
        <h3 class="text-lg font-bold mb-4 text-[#115e59]">自定义括号序列</h3>
        <div class="space-y-4">
            <div>
                <label class="text-xs font-bold text-[#0d9488] uppercase">输入字符串 (仅限 () [] {})</label>
                <input type="text" id="input-str" class="w-full mt-2 p-4 bg-teal-50 rounded-xl border border-teal-100 text-lg font-mono tracking-widest focus:border-[#0d9488] focus:ring-1 focus:ring-[#0d9488] outline-none text-[#134e4a]" placeholder="([{}])" value="([{}])">
            </div>
            <div class="flex gap-2 mt-4">
                <button onclick="quickInput('()[]{}')" class="px-3 py-1 bg-gray-100 rounded-lg text-xs font-mono">()[]{}</button>
                <button onclick="quickInput('([)]')" class="px-3 py-1 bg-gray-100 rounded-lg text-xs font-mono">([)]</button>
                <button onclick="quickInput('(((')" class="px-3 py-1 bg-gray-100 rounded-lg text-xs font-mono">(((</button>
            </div>
            <button onclick="applyCustom()" class="w-full py-3.5 bg-[#0d9488] text-white rounded-full font-bold shadow-lg shadow-teal-200 active:scale-[0.98] transition-transform mt-4">
                开始演示
            </button>
        </div>
    </div>
</div>

<script>
    lucide.createIcons();

    // --- 全局状态 ---
    const PAIRS = { ')': '(', ']': '[', '}': '{' };
    const OPEN_SET = new Set(['(', '[', '{']);

    let state = {
        inputStr: "([{}])",
        stack: [], // visual representation
        currIdx: 0,
        stepCount: 0,

        // Flow Control
        phase: 0, // 0: Pick Char, 1: Check Open/Close, 2: Stack Op
        isDone: false,
        isValid: true,

        // Playback
        playing: false,
        timer: null,
        speed: 1
    };

    // --- 初始化 ---
    function init(newStr = null) {
        if (newStr !== null) state.inputStr = newStr;

        state.stack = [];
        state.currIdx = 0;
        state.stepCount = 0;
        state.phase = 0;
        state.isDone = false;
        state.isValid = true;

        state.playing = false;
        clearTimeout(state.timer);
        updatePlayIcon();

        renderStaticUI();
        updateStatus("Stack ready. Waiting to start.", "normal");
        updateCodeHighlight(-1);

        document.getElementById('curr-char').textContent = '--';
        document.getElementById('action-text').textContent = 'Ready';
        document.getElementById('stack-container').innerHTML = '';
    }

    // --- 渲染 UI (静态部分) ---
    function renderStaticUI() {
        const container = document.getElementById('string-container');
        container.innerHTML = '';

        state.inputStr.split('').forEach((char, idx) => {
            const el = document.createElement('div');
            el.id = `char-${idx}`;
            el.className = `w-10 h-10 min-w-[2.5rem] flex items-center justify-center rounded-lg bg-white border border-teal-100 font-mono text-lg font-bold text-gray-400 transition-all-300`;
            el.textContent = char;
            container.appendChild(el);
        });

        document.getElementById('step-count').textContent = 0;
        updatePointer(-1); // Hide pointer
    }

    // --- 核心逻辑 (单步执行) ---
    function nextStep() {
        if (state.isDone) return;

        state.stepCount++;
        document.getElementById('step-count').textContent = state.stepCount;

        const char = state.inputStr[state.currIdx];

        // Phase 0: Pick Char & Highlight
        if (state.phase === 0) {
            // Check if end of string
            if (state.currIdx >= state.inputStr.length) {
                finalize();
                return;
            }

            updateCodeHighlight(1); // for char in s
            highlightChar(state.currIdx, 'active');
            updatePointer(state.currIdx);

            document.getElementById('curr-char').textContent = char;
            updateStatus(`Index ${state.currIdx}: Processing '${char}'`, "normal");

            state.phase = 1;
        }
        // Phase 1: Analyze Type (Open vs Close)
        else if (state.phase === 1) {
            if (OPEN_SET.has(char)) {
                // It is Opening
                updateCodeHighlight(2); // if open
                updateStatus(`'${char}' is an Opening bracket`, "normal");
                document.getElementById('action-text').textContent = "Push";
                document.getElementById('action-text').className = "text-sm font-bold text-[#0d9488] mt-1 text-center";
                state.phase = 2; // Go to Push
            } else {
                // It is Closing
                updateCodeHighlight(4); // else
                updateStatus(`'${char}' is a Closing bracket`, "normal");
                document.getElementById('action-text').textContent = "Check";
                document.getElementById('action-text').className = "text-sm font-bold text-orange-500 mt-1 text-center";
                state.phase = 3; // Go to Check
            }
        }
        // Phase 2: Push Op
        else if (state.phase === 2) {
            updateCodeHighlight(3); // append
            pushToStack(char);
            updateStatus(`Push '${char}' to stack`, "normal");
            highlightChar(state.currIdx, 'processed');

            // Prepare next
            state.currIdx++;
            state.phase = 0;
        }
        // Phase 3: Check & Pop Op
        else if (state.phase === 3) {
            updateCodeHighlight(5); // if check

            // Visual Check
            const topEl = document.querySelector('#stack-container .stack-item:last-child');

            if (state.stack.length === 0) {
                updateStatus(`Error: Stack is empty! No match for '${char}'`, "error");
                fail();
                return;
            }

            const topChar = state.stack[state.stack.length - 1];
            if (topChar !== PAIRS[char]) {
                // Mismatch
                if(topEl) topEl.classList.add('bg-red-500', 'text-white', 'border-red-600');
                updateStatus(`Error: Mismatch! Expected closing for '${topChar}'`, "error");
                fail();
                return;
            }

            // Match found
            if(topEl) topEl.classList.add('bg-green-500', 'text-white', 'border-green-600');
            updateStatus(`Match! '${topChar}' pairs with '${char}'`, "success");
            document.getElementById('action-text').textContent = "Pop";
            document.getElementById('action-text').className = "text-sm font-bold text-green-600 mt-1 text-center";

            state.phase = 4; // Go to Pop animation
        }
        // Phase 4: Execute Pop
        else if (state.phase === 4) {
            popFromStack();
            highlightChar(state.currIdx, 'processed');
            state.currIdx++;
            state.phase = 0;
        }
    }

    function finalize() {
        updateCodeHighlight(7); // return not stack
        if (state.stack.length === 0) {
            updateStatus("Success! Stack is empty. Valid String.", "success");
            document.getElementById('action-text').textContent = "Valid";
            document.getElementById('action-text').className = "text-xl font-bold text-green-600 mt-1 text-center";
        } else {
            updateStatus(`Failed! Stack not empty. ${state.stack.length} items left.`, "error");
            document.getElementById('action-text').textContent = "Invalid";
            document.getElementById('action-text').className = "text-xl font-bold text-red-600 mt-1 text-center";
            // Highlight remaining
            document.querySelectorAll('.stack-item').forEach(el => el.classList.add('bg-red-100', 'border-red-300'));
        }
        state.isDone = true;
        stopPlay();
    }

    function fail() {
        updateCodeHighlight(6); // return False
        highlightChar(state.currIdx, 'error');
        document.getElementById('action-text').textContent = "Invalid";
        document.getElementById('action-text').className = "text-xl font-bold text-red-600 mt-1 text-center";
        state.isDone = true;
        stopPlay();
    }

    // --- 视觉操作 ---
    function pushToStack(char) {
        state.stack.push(char);
        const container = document.getElementById('stack-container');
        const el = document.createElement('div');
        el.className = "stack-item w-16 h-10 flex items-center justify-center bg-white border-2 border-teal-500 rounded-lg shadow-sm font-bold text-teal-700 stack-enter mb-1";
        el.textContent = char;
        container.appendChild(el);
    }

    function popFromStack() {
        state.stack.pop();
        const container = document.getElementById('stack-container');
        const last = container.lastElementChild;
        if (last) {
            last.classList.remove('stack-enter');
            last.classList.add('stack-leave');
            setTimeout(() => last.remove(), 300);
        }
    }

    function highlightChar(idx, type) {
        const el = document.getElementById(`char-${idx}`);
        if (!el) return;

        // Remove active first
        el.classList.remove('char-active', 'char-processed', 'char-error', 'char-success', 'border-teal-100');
        el.classList.add('border-teal-100'); // reset border

        if (type === 'active') {
            el.classList.add('char-active');
            el.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
        } else if (type === 'processed') {
            el.classList.add('char-processed');
        } else if (type === 'error') {
            el.classList.add('char-error');
        }
    }

    function updatePointer(idx) {
        // 这里我们简单用高亮代替外部指针，或者如果需要指针：
        // 此处不做复杂定位，只依赖高亮类
    }

    function updateStatus(msg, type) {
        const el = document.getElementById('status-chip');
        el.textContent = msg;

        el.className = "mb-6 px-4 py-1.5 text-xs font-medium rounded-full shadow-sm transition-all duration-300 max-w-[90%] text-center truncate z-10 border ";

        if (type === 'normal') el.className += "bg-[#ccfbf1] text-[#115e59] border-teal-200";
        else if (type === 'success') el.className += "bg-green-100 text-green-800 border-green-200";
        else if (type === 'error') el.className += "bg-red-100 text-red-800 border-red-200";
    }

    function updateCodeHighlight(lineIdx) {
        document.querySelectorAll('[id^="code-"]').forEach(el => {
            el.className = "px-2 py-0.5 rounded transition-colors text-gray-500 whitespace-pre";
        });
        if (lineIdx >= 0) {
            const el = document.getElementById(`code-${lineIdx}`);
            if(el) {
                el.className = "px-2 py-0.5 rounded bg-[#0f766e] text-white whitespace-pre shadow-sm";
                el.scrollIntoView({block: 'nearest', behavior: 'smooth'});
            }
        }
    }

    // --- 播放控制 ---
    function togglePlay() {
        state.playing = !state.playing;
        updatePlayIcon();
        if (state.playing) {
            if (state.isDone) init(state.inputStr);
            loop();
        } else {
            clearTimeout(state.timer);
        }
    }

    function loop() {
        if (!state.playing || state.isDone) {
            state.playing = false;
            updatePlayIcon();
            return;
        }
        nextStep();
        if (!state.isDone) {
            state.timer = setTimeout(loop, 1000 / state.speed);
        }
    }

    function stopPlay() {
        state.playing = false;
        clearTimeout(state.timer);
        updatePlayIcon();
    }

    function updatePlayIcon() {
        const btn = document.getElementById('btn-play');
        btn.innerHTML = state.playing ?
            `<i data-lucide="pause" class="w-5 h-5 fill-current"></i>` :
            `<i data-lucide="play" class="w-5 h-5 ml-0.5 fill-current"></i>`;
        lucide.createIcons();
    }

    function changeSpeed() {
        const speeds = [1, 2, 0.5];
        const labels = ['1x', '2x', '0.5x'];
        const curIdx = speeds.indexOf(state.speed);
        const nextIdx = (curIdx + 1) % speeds.length;
        state.speed = speeds[nextIdx];

        const badge = document.getElementById('speed-badge');
        badge.textContent = labels[nextIdx];
        badge.style.opacity = state.speed === 1 ? 0 : 1;
    }

    function resetApp() {
        stopPlay();
        init(state.inputStr);
    }

    // --- Modal ---
    function openEditModal() {
        stopPlay();
        document.getElementById('input-str').value = state.inputStr;
        const modal = document.getElementById('modal');
        modal.classList.remove('hidden');
        setTimeout(() => {
            document.getElementById('modal-bg').classList.remove('opacity-0');
            document.getElementById('modal-panel').classList.remove('translate-y-full');
        }, 10);
    }

    function closeEditModal() {
        document.getElementById('modal-bg').classList.add('opacity-0');
        document.getElementById('modal-panel').classList.add('translate-y-full');
        setTimeout(() => {
            document.getElementById('modal').classList.add('hidden');
        }, 300);
    }

    function quickInput(val) {
        document.getElementById('input-str').value = val;
    }

    function applyCustom() {
        const val = document.getElementById('input-str').value.trim();
        // Validate simple
        if (!/^[\[\]\(\)\{\}]+$/.test(val)) {
            alert("只能包含 () [] {}");
            return;
        }
        if (val.length > 20) {
            alert("太长了，请控制在20个字符以内");
            return;
        }
        init(val);
        closeEditModal();
    }

    // 启动
    init();

</script>
</body>
</html>