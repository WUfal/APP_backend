<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>岛屿的最大面积 - 算法可视化</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        .cell-transition { transition: all 0.3s ease; }
        .fade-enter { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }

        /* 扫描光标动画 */
        @keyframes pulse-border {
            0% { border-color: rgba(245, 158, 11, 0.5); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
            70% { border-color: rgba(245, 158, 11, 1); box-shadow: 0 0 0 4px rgba(245, 158, 11, 0); }
            100% { border-color: rgba(245, 158, 11, 0.5); box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
        }
        .scanning { animation: pulse-border 1.5s infinite; }
    </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- 图标组件 ---
    const Icons = {
        Play: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>,
        Pause: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>,
        Step: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>,
        Reset: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12" /><path d="M3 3v9h9" /></svg>,
        Settings: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>,
        Shuffle: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>
    };

    const App = () => {
        // --- 状态定义 ---
        // 默认地图: 0-水, 1-陆地
        const defaultGrid = JSON.stringify([
            [0,0,1,0,0,0,0,1,0,0,0,0,0],
            [0,0,0,0,0,0,0,1,1,1,0,0,0],
            [0,1,1,0,1,0,0,0,0,0,0,0,0],
            [0,1,0,0,1,1,0,0,1,0,1,0,0],
            [0,1,0,0,1,1,0,0,1,1,1,0,0],
            [0,0,0,0,0,0,0,0,0,0,1,0,0],
            [0,0,0,0,0,0,0,1,1,1,0,0,0],
            [0,0,0,0,0,0,0,1,1,0,0,0,0]
        ]);

        const [inputStr, setInputStr] = useState(defaultGrid);

        // 核心数据
        const [grid, setGrid] = useState([]);
        const [visited, setVisited] = useState(new Set()); // 存储 "r,c" 字符串

        // 算法状态
        const [phase, setPhase] = useState("SCAN"); // 'SCAN' or 'DFS'
        const [scanPos, setScanPos] = useState({ r: 0, c: 0 });
        const [stack, setStack] = useState([]); // DFS Stack
        const [currArea, setCurrArea] = useState(0);
        const [maxArea, setMaxArea] = useState(0);

        // 运行控制
        const [isPlaying, setIsPlaying] = useState(false);
        const [isFinished, setIsFinished] = useState(false);
        const [message, setMessage] = useState("准备就绪");

        const timerRef = useRef(null);

        // --- 初始化 ---
        const parseGrid = (str) => {
            try {
                const arr = JSON.parse(str);
                if (Array.isArray(arr) && Array.isArray(arr[0])) return arr;
                return null;
            } catch (e) {
                return null;
            }
        };

        const reset = (newGridStr = inputStr) => {
            const g = parseGrid(newGridStr);
            if (!g) {
                setMessage("输入格式错误，请检查 JSON");
                return;
            }
            setGrid(g);
            setVisited(new Set());
            setPhase("SCAN");
            setScanPos({ r: 0, c: 0 });
            setStack([]);
            setCurrArea(0);
            setMaxArea(0);
            setIsPlaying(false);
            setIsFinished(false);
            setMessage("地图已重置，准备开始扫描。");
            if (timerRef.current) clearInterval(timerRef.current);
        };

        const loadInput = () => reset(inputStr);

        const randomGrid = () => {
            const rows = 8, cols = 10;
            const newGrid = [];
            for (let i = 0; i < rows; i++) {
                const row = [];
                for (let j = 0; j < cols; j++) {
                    // 30% chance of land
                    row.push(Math.random() > 0.7 ? 1 : 0);
                }
                newGrid.push(row);
            }
            const str = JSON.stringify(newGrid);
            setInputStr(str);
            reset(str);
            setMessage("随机地图生成完毕。");
        };

        useEffect(() => {
            reset();
        }, []);

        // --- 核心算法逻辑 ---
        const stepForward = () => {
            if (isFinished) return;

            const rows = grid.length;
            const cols = grid[0].length;

            // 阶段 1: 扫描寻找未访问的陆地
            if (phase === "SCAN") {
                const { r, c } = scanPos;

                if (r >= rows) {
                    setIsFinished(true);
                    setIsPlaying(false);
                    setMessage(`全图扫描结束！最大岛屿面积: ${maxArea}`);
                    return;
                }

                // 检查当前格子
                const key = `${r},${c}`;
                if (grid[r][c] === 1 && !visited.has(key)) {
                    // 发现新大陆！切换到 DFS
                    setPhase("DFS");
                    setStack([{ r, c }]);
                    setVisited(prev => new Set(prev).add(key)); // 立即标记防止重复入栈逻辑复杂化
                    setCurrArea(1); // 初始面积 1
                    setMessage(`发现新岛屿 (坐标 [${r}, ${c}])，开始 DFS 搜索。`);
                } else {
                    // 继续扫描下一个
                    let nextC = c + 1;
                    let nextR = r;
                    if (nextC >= cols) {
                        nextC = 0;
                        nextR++;
                    }
                    setScanPos({ r: nextR, c: nextC });
                    // setMessage(`扫描中... [${r}, ${c}] 是 ${grid[r][c] === 0 ? '海洋' : '已探索陆地'}`);
                }
                return;
            }

            // 阶段 2: DFS 扩散
            if (phase === "DFS") {
                if (stack.length === 0) {
                    // DFS 完成
                    setPhase("SCAN");
                    if (currArea > maxArea) {
                        setMaxArea(currArea);
                        setMessage(`当前岛屿探索完毕，面积 ${currArea} (新纪录！)。继续扫描。`);
                    } else {
                        setMessage(`当前岛屿探索完毕，面积 ${currArea}。继续扫描。`);
                    }

                    // 移动扫描指针到下一个位置 (避免死循环在当前入口)
                    let { r, c } = scanPos;
                    let nextC = c + 1;
                    let nextR = r;
                    if (nextC >= cols) {
                        nextC = 0;
                        nextR++;
                    }
                    setScanPos({ r: nextR, c: nextC });
                    return;
                }

                // 弹出栈顶
                const newStack = [...stack];
                const curr = newStack.pop();
                const { r, c } = curr;

                // 寻找邻居
                const dirs = [[0, 1], [0, -1], [1, 0], [-1, 0]];
                let foundNew = false;
                let addedCount = 0;

                const newVisited = new Set(visited);

                for (let [dr, dc] of dirs) {
                    const nr = r + dr;
                    const nc = c + dc;
                    const key = `${nr},${nc}`;

                    if (
                        nr >= 0 && nr < rows &&
                        nc >= 0 && nc < cols &&
                        grid[nr][nc] === 1 &&
                        !newVisited.has(key)
                    ) {
                        newStack.push({ r: nr, c: nc });
                        newVisited.add(key); // 标记
                        addedCount++;
                    }
                }

                setVisited(newVisited);
                setStack(newStack);
                setCurrArea(prev => prev + addedCount);
                if (addedCount > 0) {
                    setMessage(`从 [${r}, ${c}] 扩散，发现 ${addedCount} 块新陆地。`);
                } else {
                    // setMessage(`[${r}, ${c}] 无新邻居，回溯。`);
                }
            }
        };

        // --- 自动播放 ---
        useEffect(() => {
            let timer;
            if (isPlaying && !isFinished) {
                // DFS 时稍微慢一点，Scan 时快一点
                const interval = phase === "DFS" ? 600 : 100;
                timer = setInterval(() => {
                    stepForward();
                }, interval);
            }
            return () => clearInterval(timer);
        }, [isPlaying, isFinished, phase, scanPos, stack, visited, grid, currArea, maxArea]);

        // --- 渲染 ---
        const getCellClass = (r, c) => {
            const isLand = grid[r][c] === 1;
            const key = `${r},${c}`;
            const isVisited = visited.has(key);

            // 基础样式
            let base = "w-8 h-8 sm:w-10 sm:h-10 border rounded-sm flex items-center justify-center text-xs relative cell-transition ";

            if (isLand) {
                if (isVisited) {
                    // 已探索的陆地 (深绿/棕色)
                    base += "bg-emerald-600 border-emerald-700 text-white shadow-inner ";
                } else {
                    // 未探索的陆地 (鲜绿)
                    base += "bg-emerald-400 border-emerald-500 ";
                }
            } else {
                // 水 (浅蓝)
                base += "bg-cyan-50 border-cyan-100 ";
            }

            // 扫描光标
            if (phase === "SCAN" && scanPos.r === r && scanPos.c === c) {
                base += "scanning z-10 border-amber-400 border-2 ";
            }

            // DFS 当前处理 (栈顶)
            const isStackTop = stack.length > 0 && stack[stack.length - 1].r === r && stack[stack.length - 1].c === c;
            if (phase === "DFS" && isStackTop) {
                base += "bg-amber-400 border-amber-500 scale-110 z-20 ring-2 ring-amber-200 ";
            }

            return base;
        };

        return (
            <div className="max-w-4xl mx-auto p-4 sm:p-6">
                {/* 1. 顶部配置 */}
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 mb-6">
                    <div className="flex items-center gap-2 mb-3 text-slate-700 font-bold">
                        <Icons.Settings />
                        <span>地图配置 (JSON 格式)</span>
                    </div>
                    <div className="flex flex-col gap-3">
                        <textarea
                            value={inputStr}
                            onChange={(e) => setInputStr(e.target.value)}
                            className="w-full border border-slate-300 rounded-lg px-3 py-2 font-mono text-xs sm:text-sm focus:outline-none focus:ring-2 focus:ring-teal-500 h-20 resize-none"
                            placeholder="[[0,1],[1,0]...]"
                        />
                        <div className="flex gap-2">
                            <button onClick={loadInput} className="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition font-medium text-sm">
                                加载地图
                            </button>
                            <button onClick={randomGrid} className="px-3 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 transition" title="随机生成">
                                <Icons.Shuffle />
                            </button>
                        </div>
                    </div>
                </div>

                {/* 2. 主体区 */}
                <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
                    {/* Header */}
                    <div className="border-b border-slate-100 bg-slate-50 p-4 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div>
                            <h1 className="text-xl font-bold text-slate-800">岛屿的最大面积</h1>
                            <p className="text-xs text-slate-500 mt-1">深度优先搜索 (DFS) · LeetCode 695</p>
                        </div>
                        <div className="flex gap-6">
                            <div className="flex flex-col items-center">
                                <span className="text-xs font-bold text-slate-400 uppercase">Current Area</span>
                                <span className={`text-2xl font-bold ${phase === 'DFS' ? 'text-amber-500' : 'text-slate-600'}`}>{currArea}</span>
                            </div>
                            <div className="flex flex-col items-center">
                                <span className="text-xs font-bold text-slate-400 uppercase">Max Area</span>
                                <span className="text-2xl font-black text-teal-600">{maxArea}</span>
                            </div>
                        </div>
                    </div>

                    {/* Canvas */}
                    <div className="p-6 bg-slate-50 min-h-[300px] flex justify-center items-center overflow-auto">
                        <div className="grid gap-1 p-2 bg-white rounded-lg border border-slate-200 shadow-sm"
                             style={{ gridTemplateColumns: `repeat(${grid[0]?.length || 1}, minmax(0, 1fr))` }}>
                            {grid.map((row, r) => (
                                row.map((val, c) => (
                                    <div key={`${r}-${c}`} className={getCellClass(r, c)}>
                                        {/* Optional: Coordinates for debugging */}
                                        {/* <span className="hidden sm:block scale-50 opacity-30">{r},{c}</span> */}
                                    </div>
                                ))
                            ))}
                        </div>
                    </div>

                    {/* Controls */}
                    <div className="border-t border-slate-100 p-4 bg-white">
                        <div className="flex flex-col sm:flex-row items-center justify-between gap-4">
                            <div className={`flex-1 px-4 py-3 rounded-lg text-sm border-l-4 w-full sm:w-auto transition-colors ${phase === 'DFS' ? 'bg-amber-50 text-amber-900 border-amber-500' : 'bg-teal-50 text-teal-900 border-teal-500'}`}>
                                {message}
                            </div>

                            <div className="flex items-center gap-2">
                                <button onClick={() => setIsPlaying(!isPlaying)} disabled={isFinished} className={`flex items-center gap-2 px-4 py-2 rounded-lg text-white font-medium transition ${isPlaying ? 'bg-slate-500 hover:bg-slate-600' : 'bg-teal-600 hover:bg-teal-700'} disabled:opacity-50`}>
                                    {isPlaying ? <Icons.Pause /> : <Icons.Play />}
                                    <span className="hidden sm:inline">{isPlaying ? "暂停" : "运行"}</span>
                                </button>
                                <button onClick={stepForward} disabled={isPlaying || isFinished} className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 font-medium transition disabled:opacity-50">
                                    <Icons.Step />
                                    <span className="hidden sm:inline">单步</span>
                                </button>
                                <button onClick={() => reset()} className="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition" title="重置">
                                    <Icons.Reset />
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>